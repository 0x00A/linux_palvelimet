## Artikkelin tiivistys[^1][^2][^3]
- Apache käyttää nimipohjaista reititystä.
- Nimipohjainen reititys mahdollistaa useiden eri verkkotunnusten käytön samalla IP-osoitteella.
- Apache palvelin reitittää pyynnöt oikeaan verkkotunnukseen HTTP headereissä olevan "Host" kentän perusteella.
- Virtuaalipalvelimet määritellään Apache:n konfiguraatiotiedostoissa. (`/etc/apache2/sites-available/`)
- Virtuaalipalvelimet aktivoidaan `a2ensite` komennolla, deaktivoidaan `a2dissite` komennolla, jotta muutokset tulevat voimaan, tulee konfiguraatiotiedostot ladata uudelleen komennolla `systemctl reload apache2`.

## Tehtävät

### a) Apachen asennus ja testaus
Asennus:
```bash
sudo apt install apache2 -y
```

Testaus:
```bash
$ sudo systemctl status apache2 # tarkistetaan että apache on käynnissä
● apache2.service - The Apache HTTP Server
     Loaded: loaded (/usr/lib/systemd/system/apache2.service; enabled; preset: >
     Active: active (running) since Sun 2025-09-07 19:42:09 EEST; 1min 25s ago
     ...
```

```bash
$ curl -I 127.0.0.1 # käytetään -I lippua jolloin suoritetaan HTTP HEAD pyyntö, joka palauttaa vain headerit ilman sisältöä
HTTP/1.1 200 OK
Date: Sun, 07 Sep 2025 16:48:24 GMT
Server: Apache/2.4.65 (Debian)
Last-Modified: Sun, 07 Sep 2025 16:42:07 GMT
ETag: "29cf-63e38c06e966e"
Accept-Ranges: bytes
Content-Length: 10703
Vary: Accept-Encoding
Content-Type: text/html
```


### b) Logien tarkastelu
```bash
$ sudo cat /var/log/apache2/access.log
127.0.0.1 - - [07/Sep/2025:19:48:24 +0300] "HEAD / HTTP/1.1" 200 255 "-" "curl/8.14.1"
```
Tästä ei syntynyt kovin paljon lokeja koska HEAD pyyntö ei lataa sivun sisältöä.

- `127.0.0.1` on pyynnön tehneen koneen IP-osoite
- `[07/Sep/2025:19:48:24 +0300]` pyynnön aikaleima
- `"HEAD / HTTP/1.1"` pyynnön tyyppi, polku ja käytetty HTTP versio
- `200` on HTTP vastauksen statuskoodi, 200 tarkoittaa OK
- `255` on vastauksen koko tavuina
- `"curl/8.14.1"` on user-agent, eli ohjelma jolla pyyntö tehtiin

Tehdään vielä GET pyyntö selaimella jotta saadaan enemmän lokeja:
```bash
127.0.0.1 - - [07/Sep/2025:19:53:56 +0300] "GET / HTTP/1.1" 200 3383 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0"
127.0.0.1 - - [07/Sep/2025:19:53:56 +0300] "GET /icons/openlogo-75.png HTTP/1.1" 200 6040 "http://127.0.0.1/" "Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0"
127.0.0.1 - - [07/Sep/2025:19:53:56 +0300] "GET /favicon.ico HTTP/1.1" 404 487 "http://127.0.0.1/" "Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0"
```
Lokin formaatti on sama kuin aiemmin, mutta nyt on enemmän pyyntöjä esim. sivulla olevalle kuvalle (200 OK) ja pikkukuvakkeelle (favicon.ico), jonka selaimet yrittävät käydä hakemassa automaattisesti, kuitenkin vastauksena pikkukuvakkaelle on saatu 404 Not Found, sillä faviconia ei löydy.

Lisäksi kahdessa viimeisessä pyynnössä näkyy referer header vastauksen koon jälkeen `"http://127.0.0.1/"`, tämä kertoo miltä sivulta pyyntö on aloitettu.

### c) & e) Etusivu uusiksi
Sivun luonti:
```bash
mkdir -p $HOME/public_sites/hattu.example.com/
# tietääkseni lyhyin mahdollinen valid html5 sivu
echo '<!DOCTYPE html><html lang="fi"><title>hattu</title>' > $HOME/public_sites/hattu.example.com/index.html
```
![valid](/assets/h3/valid_page.png)


Konfiguraation luonti[^2][^3]:
```bash
# käytän Helix editoria, mutta mikä vaan editori käy (https://helix-editor.com/)
$ sudo hx /etc/apache2/sites-available/hattu.example.com.conf
$ cat /etc/apache2/sites-available/hattu.example.com.conf
<VirtualHost *:80>
 ServerName hattu.example.com
 DocumentRoot /home/user/public_sites/hattu.example.com
 <Directory /home/user/public_sites/hattu.example.com>
   Require all granted
 </Directory>
</VirtualHost>
```

Oikeudet:
```bash
sudo chmod o+x /home /home/user /home/user/public_sites /home/user/public_sites/hattu.example.com/
sudo chmod o+r /home/user/public_sites/hattu.example.com/index.html
```

Hosts tiedoston muokkaus:
```bash
# tehdään kopio alkuperäisestä varmuuden vuoksi
sudo cp /etc/hosts $HOME/hosts.bak

# lisätään host tiedostoon rivit jotta example.com ja hattu.example.com osoittaa localhostiin
echo -e "127.0.0.1 example.com\n127.0.0.1 hattu.example.com" | sudo tee -a /etc/hosts
```

Apachen konfiguraation aktivointi ja lataus uudelleen:
```bash
# laitetaan uusi sivusto käyttöön
sudo a2ensite hattu.example.com.conf
# poistetaan oletussivusto käytöstä
sudo a2dissite 000-default.conf
# ladataan konfiguraatiotiedostot uudelleen jotta muutokset tulevat voimaan
sudo systemctl reload apache2
```

Testaus:
```bash
$ curl localhost
<!DOCTYPE html><html lang="fi"><title>hattu</title>
$ curl example.com
<!DOCTYPE html><html lang="fi"><title>hattu</title>
$ curl hattu.example.com
<!DOCTYPE html><html lang="fi"><title>hattu</title>
```


### f) curl -I & HTTP HEAD
Näitä tulikin jo aiemmin käytettyä a) tehtävässä, mutta selitän tässä tarkemmin mitä headerit tarkoittavat.

```bash
$ curl -I example.com
Date: Sun, 07 Sep 2025 18:28:57 GMT
Server: Apache/2.4.65 (Debian)
Last-Modified: Sun, 07 Sep 2025 17:44:22 GMT
ETag: "34-63e399f056e8f"
Accept-Ranges: bytes
Content-Length: 52
Content-Type: text/html
```

- `Date` on vastauksen aikaleima
- `Server` kertoo palvelinohjelmiston nimen ja version
- `Last-Modified` kertoo milloin tiedostoa on viimeksi muokattu
- `ETag` on tiedoston yksilöivä tunniste, jota voidaan käyttää esimerkiksi välimuistitukseen[^4]
- `Accept-Ranges` joko `bytes` tai `none`, kertoo tukeeko palvelin osittaista latausta
- `Content-Length` kertoo sisällön koon tavuina
- `Content-Type` kertoo sisällön mediatyypin

### o) Kaksi eri sivustoa

```bash
# luodaan uusi conf tiedosto käyttäen hattu conf tiedostoa pohjana, vaihdetaan kaikki "hattu" sanat "foo":ksi
sudo sed 's/hattu/foo/g' /etc/apache2/sites-available/hattu.example.com.conf | sudo tee /etc/apache2/sites-available/foo.example.com.conf

mkdir -p $HOME/public_sites/foo.example.com/

# tehdään yllä mainittu temppu myös itse sivustolle (ilman sudoa)
sed 's/hattu/foo/g' $HOME/public_sites/hattu.example.com/index.html | tee $HOME/public_sites/foo.example.com/index.html

# lisätään hosts tiedostoon
echo "127.0.0.1 foo.example.com" | sudo tee -a /etc/hosts

# otetaan uusi sivusto käyttöön
sudo a2ensite foo.example.com.conf
sudo systemctl reload apache2
```

Testataan:
```bash
curl localhost
<!DOCTYPE html><html lang="fi"><title>foo</title>

$ curl example.com
<!DOCTYPE html><html lang="fi"><title>foo</title>

$ curl foo.example.com
<!DOCTYPE html><html lang="fi"><title>foo</title>

$ curl hattu.example.com
<!DOCTYPE html><html lang="fi"><title>hattu</title>
```

Huom. `localhost` ja `example.com` palauttaa nyt `foo` koska oletussivusto on otettu pois käytöstä, Apache palauttaa aakkosjärjestyksessä ensimmäisen osuvan sivuston, tässä tapauksessa `foo.example.com`.


## Lähteet:
- Tehtävänanto: https://terokarvinen.com/linux-palvelimet/#h3-hello-web-server
[^1]: The Apache Software Foundation 2025. Name-based Virtual Host Support - Apache HTTP Server Version 2.4. Luettavissa: https://httpd.apache.org/docs/2.4/vhosts/name-based.html. Luettu: 07.09.2025.
[^2]: Tero Karvinen 2018. Name Based Virtual Hosts on Apache – Multiple Websites to Single IP Address | Tero Karvinen. Luettavissa: https://terokarvinen.com/2018/04/10/name-based-virtual-hosts-on-apache-multiple-websites-to-single-ip-address/. Luettu: 07.09.2025.
[^3]: Johanna Heinonen 2025. johanna-test-repo/linux-03092025.md at main · johannaheinonen/johanna-test-repo · GitHub. Luettavissa: https://github.com/johannaheinonen/johanna-test-repo/blob/main/linux-03092025.md. Luettu: 07.09.2025.
[^4]: Mozilla Corporation. ETag header - HTTP | MDN. Luettavissa: https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/ETag. Luettu: 07.09.2025.